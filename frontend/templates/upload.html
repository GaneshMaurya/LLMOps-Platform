<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Upload Model - LLMOps</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>

<body class="bg-light">
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
			<a class="navbar-brand" href="{{ url_for('home') }}">ML Model Platform</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
				aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav me-auto">
					<li class="nav-item">
						<a class="nav-link {% if request.endpoint == 'home' %}active{% endif %}"
							href="{{ url_for('home') }}">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link {% if request.endpoint == 'upload' %}active{% endif %}"
							href="{{ url_for('upload') }}">Upload</a>
					</li>
					<li class="nav-item">
						<a class="nav-link {% if request.endpoint == 'model_list' %}active{% endif %}"
							href="{{ url_for('model_list') }}">Models</a>
					</li>
				</ul>
				<ul class="navbar-nav">
					<li class="nav-item">
						<span class="nav-link text-light">Welcome, {{ session['user'] }}</span>
					</li>
					<li class="nav-item">
						<form action="{{ url_for('logout') }}" method="post" class="d-inline">
							<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
							<button type="submit" class="btn btn-danger my-2 my-sm-0">Logout</button>
						</form>
					</li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container py-5">
		<h2 class="mb-4">Upload Model</h2>

		<!-- Model Name Input -->
		<div class="mb-3">
			<label for="model_name" class="form-label">Model Name</label>
			<input type="text" class="form-control" id="model_name" name="model_name"
				placeholder="Enter a name for the model" required />
		</div>

		<!-- File Upload Input -->
		<div class="mb-3">
			<label for="model_zip" class="form-label">Upload Model ZIP File</label>
			<input type="file" class="form-control" id="model_zip" name="model_zip" accept=".zip" required />
		</div>

		<button class="btn btn-primary" onclick="uploadModel()">Upload</button>
		<div id="upload_status" class="mt-4"></div>

		<a href="{{ url_for('home') }}" class="btn btn-secondary mt-4">Back to Home</a>
	</div>

	<script>
		const username = "{{ username }}"; // Injected from Flask
		console.log(username);

		async function uploadModel() {
			const fileInput = document.getElementById("model_zip");
			const modelNameInput = document.getElementById("model_name");

			const file = fileInput.files[0];
			const model_name = modelNameInput.value.trim();

			if (!file || !model_name) {
				showMessage("Please provide both model name and zip file.", "danger");
				return;
			}

			if (!file.name.endsWith(".zip")) {
				showMessage("Only .zip files are allowed.", "danger");
				return;
			}

			const text = `${file.name}_${username}`;
			const model_id = await generateUUID(text);
			const formData = new FormData();
			formData.append("model_id", model_id);
			formData.append("model_file", file);
			formData.append("model_name", model_name);
			formData.append("user_id", username);
			console.log(model_id);

			try {
				const response = await fetch(
					`http://192.168.141.124:8000/registry/upload-and-validate/${model_id}`,
					{
						method: "POST",
						body: formData,
					}
				);
				console.log("before Response");
				const result = await response.json();
				console.log("After response");
				console.log(result);

				if (result.status === "COMPLETED") {
					showMessage("Model Uploaded Successfully!", "success");
				} else {
					showMessage("Model Upload Failed.", "danger");
				}
			} catch (error) {
				showMessage("Error uploading model: " + error, "danger");
			}
		}

		function showMessage(message, type) {
			const statusDiv = document.getElementById("upload_status");
			statusDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
		}

		async function generateUUID(text) {
			const namespace = "6ba7b810-9dad-11d1-80b4-00c04fd430c8"; // DNS namespace
			const encoder = new TextEncoder();
			const data = encoder.encode(namespace + text);
			const hashBuffer = await crypto.subtle.digest("SHA-1", data);
			const hash = new Uint8Array(hashBuffer);

			hash[6] = (hash[6] & 0x0f) | 0x50; // Version 5
			hash[8] = (hash[8] & 0x3f) | 0x80; // Variant 10

			const uuid = [...hash.slice(0, 16)]
				.map((b, i) => {
					const hex = b.toString(16).padStart(2, "0");
					if (i === 4 || i === 6 || i === 8 || i === 10) return "-" + hex;
					return hex;
				})
				.join("");

			return uuid;
		}
	</script>
</body>

</html>